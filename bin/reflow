#!/usr/bin/env ruby

require "rubygems"
require "bundler/setup"

$: << File.join(File.dirname(__FILE__), '..', 'lib')

require "as3"

lines = []
function = nil

ARGF.each do |line|
  if line =~ /^{ (.*)/
    function = $1
    lines = []
  elsif line =~ /^}/
    stream = AS3::Stream.new
    stream.parse_assembly(lines)

    transforms = [
                  AS3::Transforms::DeadCodeElimination.new
                ]

    transforms.each do |transform|
    transform.run(stream)
    end

    puts "{ #{function}"
    puts stream.to_assembly
    puts "}"
  else
    lines << line
  end
end